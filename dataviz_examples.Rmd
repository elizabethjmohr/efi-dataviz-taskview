---
title: "Data Visualization Examples"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message = FALSE, warning = FALSE) # Show code and plots

# Load packages
library(tidyverse)
library(lubridate)
library(cowplot)
library(palmerpenguins)
library(ggridges)
library(GGally)
library(ggdist)
library(ggExtra)
library(viridis)

# Get target data
aquatics_targets <- readr::read_csv("https://data.ecoforecast.org/targets/aquatics/aquatics-targets.csv.gz")
#terrestrial_30min_targets <- readr::read_csv("https://data.ecoforecast.org/targets/terrestrial/terrestrial_30min-targets.csv.gz", guess_max = 1e6)
terrestrial_daily_targets <- readr::read_csv("https://data.ecoforecast.org/targets/terrestrial/terrestrial_daily-targets.csv.gz", guess_max = 1e6)
pheno_targets <- readr::read_csv("https://data.ecoforecast.org/targets/phenology/phenology-targets.csv.gz")
tick_targets <- readr::read_csv("https://data.ecoforecast.org/targets/ticks/ticks-targets.csv.gz")
beetle_targets <- readr::read_csv("https://data.ecoforecast.org/targets/beetles/beetles-targets.csv.gz", guess_max = 1e6)

# Get forecasts
combined <- read_csv("https://data.ecoforecast.org/analysis/combined_forecasts_scores.csv.gz")
aquatic_temp <- combined %>% 
  filter(theme == "aquatics", target == "temperature", !team == "EFInull")
#aquatic_oxygen <- combined %>%
  #filter(theme == "aquatics", target == "oxygen", !team == "EFInull")
#terrestrial_30min <- combined %>% 
  #filter(theme == "terrestrial_30min", !team == "EFInull")
#terrestrial_daily <- combined %>% 
  #filter(theme == "terrestrial_daily", !team == "EFInull")
#pheno <- combined %>% 
  #filter(theme == "phenology", !team == "EFInull")
#ticks <- combined %>% 
  #filter(theme == "ticks", !team == "EFInull")
#beetles <- combined %>% 
  #filter(theme == "beetles", !team == "EFInull")
```

## Histogram

```{r histogram, fig.cap = "Histogram of scores for water temperature forecasts from the EFI NEON Ecological Forecasting Challenge"}

ggplot(aquatic_temp, aes(x = crps)) +
  geom_bar()+
  scale_x_binned()+
  theme_minimal_hgrid()+
  ylab("number of forecasts") + 
  xlab("continuous ranked probability score")
```
```{r histogram2D}
p <- ggplot(pheno_targets, aes(x = gcc_90, y = rcc_90)) +
  geom_hex(bins = 60)+
  geom_point(color = "transparent")+
  ylab("greenness index") + 
  xlab("redness index")+
  theme_cowplot()+
  scale_fill_viridis()+
  theme(legend.position = c(0.8, 0.8))

ggMarginal(p,type = "histogram", fill = "grey80")

```

## Density Plot

```{r density, fig.cap = "Density plot for a log-normal distribution with mean = 0 and standard deviation = 1"}
ggplot() +
  geom_area(data = tibble(x = seq(0.01, 4, 0.01), y = dlnorm(seq(0.01, 4, 0.01))), aes(x = x, y = y), fill = "#4477AA", color = "black")+
  #geom_function(data = tibble(x = c(0,3)), aes(x = x), fun = dlnorm)+
  xlim(c(0,4))+
  theme_minimal_hgrid()+
  ylab("probability density")+
  theme(axis.title.x = element_blank())
```

## Quantile Dotplots

```{r qdotplot}

```

## Boxplot 

```{r boxplot, warning=FALSE, fig.cap="Body-mass distributions for three penguin species shown as boxplots."}
ggplot(data = penguins) +
  geom_boxplot(aes(x = species, y = body_mass_g), fill = "#BBBBBB") +
  theme_minimal() +
  xlab("species") +
  ylab("body mass (g)")
```

## Violin Plot

```{r violin, warning=FALSE, fig.cap="Body-mass distributions for three penguin species shown as violin plots."}
ggplot(data = penguins) +
  geom_violin(aes(x = species, y = body_mass_g), fill = "#BBBBBB") +
  theme_cowplot() +
  xlab("species") +
  ylab("body mass (g)")
```

## Ridgeline Plot 

```{r ridgeline, warning=FALSE, fig.cap="Body-mass distributions for three penguin species shown as staggered density plots or 'ridgeline' plots."}
ggplot(data = penguins) +
  geom_density_ridges(aes(x = body_mass_g, y = species), fill = "#BBBBBB") +
  theme_minimal_grid() +
  xlab("species") +
  ylab("body mass (g)")
```

## Scatterplot

```{r scatterplot, warning=FALSE, fig.cap="Scatterplot of penguin flipper length vs. body mass."}
ggplot(data = penguins) +
  geom_point(aes(x = flipper_length_mm, y = body_mass_g)) +
  theme_minimal_grid() +
  xlab("flipper length (mm)") +
  ylab("body mass (g)")
```

## Line graph

```{r line, fig.cap="Line graph of dissolved oxygen concentrations at the Posey Creek NEON site, 2019-2020"}
aquatics_targets %>% 
  filter(year(time) <= 2020, 
         year(time) >= 2019,
         siteID == "POSE") %>%
  ggplot(aes(x = time, y = oxygen))+
  geom_line()+
  theme_minimal_grid()+
  ylab(expression(paste("dissolved oxygen (mg ", L^-1, ")")))+
  theme(axis.title.x = element_blank())
```

```{r pointline, fig.cap="Line graph with dots showing dissolved oxygen concentrations at the Posey Creek NEON site, June 2021"}
aquatics_targets %>% 
  filter(year(time) == 2021, 
         month(time) == 6,
         siteID == "POSE") %>%
  ggplot(aes(x = time, y = oxygen))+
  geom_line()+
  geom_point()+
  theme_minimal_grid()+
  ylab(expression(paste("dissolved oxygen (mg ", L^-1, ")")))+
  theme(axis.title.x = element_blank())
```

## Pairs plots and Correlograms

```{r pairs, fig.cap = "Combined scatterplot matrix and correlation matrix for three targets in the daily terrestrial forecast challenge."}
terrestrial_daily_targets %>%
  select("ecosystem exchange" = "nee", "evapotranspiration" = "le", "soil moisture" = "vswc") %>% 
  ggpairs()+
  theme_minimal_grid(font_size = 12)
```

## Barplots

```{r barplot, fig.cap="Number of penguins observed at three islands in Palmer Archipelago, Antarctica, 2007-2009."}
ggplot(data = penguins) +
  geom_bar(aes(x = island), fill = "#4477AA") +
  theme_minimal_hgrid() +
  xlab("island") +
  ylab("count")
```

## Heatmap

```{r heatmap, fig.cap = "Heatmap of monthly beetle species richness observations at 47 NEON sites, 2017-2019.", fig.height = 6, fig.width  = 5}
siteIDLevels <- beetle_targets %>%
  filter(year(time) >=2017,
         year(time) <=2019) %>%
  group_by(siteID) %>%
  summarise(meanRichness = mean(richness, na.rm = TRUE)) %>%
  arrange(meanRichness) %>%
  pull(siteID)

expand_grid(year = 2017:2019,
            month = 1:12, 
            siteID = unique(beetle_targets$siteID)) %>%
  mutate(monthYear = paste0(year, "-", if_else(nchar(month) == 1, paste0("0", month), as.character(month)))) %>%
  left_join(beetle_targets %>%
    mutate(month = month(time),
         year = year(time), 
         monthYear = paste0(year, "-", if_else(nchar(month) == 1, paste0("0", month), as.character(month)))) %>%
    filter(year >= 2017, year <= 2019),
  by = c("siteID", "monthYear")) %>%
  mutate(siteID = factor(siteID, levels = siteIDLevels)) %>%
ggplot(aes(x = monthYear, y = siteID)) +
  geom_tile(width = 0.9, height = 0.9, aes(fill = richness)) + 
  theme_cowplot(font_size = 13)+
  scale_fill_viridis(option = "B", na.value = "#BBBBBB", direction = -1, end = 0.9) +
  ylab("site")+
  theme(axis.line = element_blank(),
        axis.ticks = element_blank(), 
        axis.title.x = element_blank(),
        axis.text.x = element_blank(),
        panel.background = element_rect(fill = "white"),
        axis.text.y = element_text(size = 9)) +
      coord_cartesian(clip = 'off') +
annotate("text", 
         x = c(6, 18, 30), 
         y = c(-3.7, -3.7, -3.7), 
         label = c("2017", "2018", "2019")) +
  annotate("segment", 
           x = 1, xend = 12, y = -2.8, yend = -2.8) + 
  annotate("segment", 
           x = 13, xend = 24, y = -2.8, yend = -2.8) + 
  annotate("segment", 
           x = 25, xend = 37, y = -2.8, yend = -2.8) + 
annotate("text",
         x = 1:36,
         y = rep(-1, times = 36),
         label = rep(c("Jan", "Feb", "March", "April", "May", "June", "July", "Aug", "Sept", "Oct", "Nov", "Dec"), times = 3),
         angle = '90', 
         size = 3)
```

## Composite Plots

```{r facet, fig.cap = "Scatterplots showing tick counts per square meter for epidemiological weeks during which sampling occurred in 2019. Plots are faceted by NEON site and tick species."}

species.labs <- c("amblyomma_americanum" = "Amblyomma americanum", 
                  "ixodes_scapularis" = "Ixodes scapularis")
tick_targets %>%
  drop_na(totalSampledArea) %>%
  filter(Year == 2019, siteID %in% c("ORNL", "SCBI", "SERC")) %>%
  group_by(epiWeek, siteID) %>%
  summarise(amblyomma_americanum = mean(amblyomma_americanum/totalSampledArea, na.rm = TRUE), 
            ixodes_scapularis = mean(ixodes_scapularis/totalSampledArea, na.rm = TRUE)) %>%
  pivot_longer(cols = c("amblyomma_americanum","ixodes_scapularis"),
               names_to = "species", 
               values_to = "ticks_m2_week") %>%
ggplot(aes(x = epiWeek, y = ticks_m2_week, color = species)) +
  geom_point(size = 2.5)+
  facet_grid(species ~ siteID,
             labeller = labeller(species = species.labs))+
  xlim(c(10,45))+
  xlab("ISO week")+
  ylab(expression(paste("number of ticks per ", m^2)))+
  scale_color_manual(values = c("#BB5566", "#004488"))+
  theme(legend.position = "none",
        strip.text.y = element_text(face = "italic"))
```
